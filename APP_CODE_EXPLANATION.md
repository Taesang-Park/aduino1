# ë¬¼ ì„­ì·¨ëŸ‰ ëª¨ë‹ˆí„°ë§ ì•± - ì½”ë“œ ìƒì„¸ ì„¤ëª…ì„œ

**ëŒ€ìƒ**: ê°œë°œì, ì½”ë“œ ë¦¬ë·°ì–´, í•™ìŠµì
**ë‚œì´ë„**: ì¤‘ê¸‰~ê³ ê¸‰
**ì‘ì„±ì¼**: 2025-01-08

---

## ğŸ“‹ ëª©ì°¨

1. [ì•± ê°œìš”](#1-ì•±-ê°œìš”)
2. [ê¸°ìˆ  ìŠ¤íƒ](#2-ê¸°ìˆ -ìŠ¤íƒ)
3. [í”„ë¡œì íŠ¸ êµ¬ì¡°](#3-í”„ë¡œì íŠ¸-êµ¬ì¡°)
4. [ì•„í‚¤í…ì²˜ ì„¤ëª…](#4-ì•„í‚¤í…ì²˜-ì„¤ëª…)
5. [ê³„ì¸µë³„ ìƒì„¸ ì„¤ëª…](#5-ê³„ì¸µë³„-ìƒì„¸-ì„¤ëª…)
6. [ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ë™ì‘ ì›ë¦¬](#6-ì£¼ìš”-ì»´í¬ë„ŒíŠ¸-ë™ì‘-ì›ë¦¬)
7. [ë°ì´í„° íë¦„](#7-ë°ì´í„°-íë¦„)
8. [ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  ë©”ì»¤ë‹ˆì¦˜](#8-ë¸”ë£¨íˆ¬ìŠ¤-í†µì‹ -ë©”ì»¤ë‹ˆì¦˜)
9. [UI/UX êµ¬í˜„](#9-uiux-êµ¬í˜„)
10. [í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ ë¶„ì„](#10-í•µì‹¬-ê¸°ëŠ¥-êµ¬í˜„-ë¶„ì„)
11. [ì½”ë“œ ì˜ˆì‹œ ë° ë¶„ì„](#11-ì½”ë“œ-ì˜ˆì‹œ-ë°-ë¶„ì„)
12. [í™•ì¥ í¬ì¸íŠ¸](#12-í™•ì¥-í¬ì¸íŠ¸)

---

## 1. ì•± ê°œìš”

### 1.1 í”„ë¡œì íŠ¸ ëª©ì 

ë¡œë“œì…€ê³¼ ì•„ë‘ì´ë…¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»µì˜ ë¬¼ ë¬´ê²Œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¸¡ì •í•˜ê³ , ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ì¼ì¼ ë¬¼ ì„­ì·¨ëŸ‰ì„ ìë™ìœ¼ë¡œ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ëŠ” Android ì•±ì…ë‹ˆë‹¤.

### 1.2 í•µì‹¬ ê¸°ëŠ¥

```
1. ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹ 
   â””â”€ Arduino HC-05/06ê³¼ ì—°ê²°
   â””â”€ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
   â””â”€ ì–‘ë°©í–¥ ëª…ë ¹ ì „ì†¡

2. ìë™ ì„­ì·¨ ê°ì§€
   â””â”€ ë¬´ê²Œ ë³€í™” ìë™ ê°ì§€
   â””â”€ ë§ˆì‹  ì–‘ ê³„ì‚°
   â””â”€ ë°ì´í„°ë² ì´ìŠ¤ ìë™ ì €ì¥

3. ë°ì´í„° ê´€ë¦¬
   â””â”€ Room Database ì˜êµ¬ ì €ì¥
   â””â”€ ë‚ ì§œë³„ ê¸°ë¡ ê´€ë¦¬
   â””â”€ í†µê³„ ê³„ì‚°

4. ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤
   â””â”€ Jetpack Compose ë°˜ì‘í˜• UI
   â””â”€ Material3 ë””ìì¸
   â””â”€ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
```

---

## 2. ê¸°ìˆ  ìŠ¤íƒ

### 2.1 ì–¸ì–´ ë° í”„ë ˆì„ì›Œí¬

```kotlin
ì–¸ì–´: Kotlin 1.9.0
ìµœì†Œ SDK: Android 7.0 (API 24)
íƒ€ê²Ÿ SDK: Android 14 (API 36)
```

### 2.2 ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬

| ì¹´í…Œê³ ë¦¬ | ë¼ì´ë¸ŒëŸ¬ë¦¬ | ë²„ì „ | ìš©ë„ |
|---------|-----------|------|------|
| UI | Jetpack Compose | 2024.02.00 | ì„ ì–¸í˜• UI |
| UI | Material3 | Latest | ë””ìì¸ ì‹œìŠ¤í…œ |
| ì•„í‚¤í…ì²˜ | ViewModel | 2.7.0 | MVVM íŒ¨í„´ |
| ì•„í‚¤í…ì²˜ | LiveData | 2.7.0 | ìƒëª…ì£¼ê¸° ì¸ì‹ ë°ì´í„° |
| ë°ì´í„°ë² ì´ìŠ¤ | Room | 2.6.1 | ë¡œì»¬ ì €ì¥ì†Œ |
| ë¹„ë™ê¸° | Coroutines | 1.7.3 | ë¹„ë™ê¸° ì²˜ë¦¬ |
| ë°˜ì‘í˜• | Flow | - | ë°ì´í„° ìŠ¤íŠ¸ë¦¼ |
| ë„¤ë¹„ê²Œì´ì…˜ | Navigation Compose | 2.7.7 | í™”ë©´ ì „í™˜ |
| ê¶Œí•œ | Accompanist Permissions | 0.34.0 | ê¶Œí•œ ì²˜ë¦¬ |

### 2.3 ì•„í‚¤í…ì²˜ íŒ¨í„´

```
MVVM (Model-View-ViewModel)
+ Clean Architecture (3-Layer)
+ Repository Pattern
+ Reactive Programming (Flow)
```

---

## 3. í”„ë¡œì íŠ¸ êµ¬ì¡°

### 3.1 ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
app/src/main/java/com/example/aduino1/
â”‚
â”œâ”€â”€ data/                           # ë°ì´í„° ê³„ì¸µ
â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â””â”€â”€ WaterRecord.kt      # Room Entity
â”‚   â”‚   â””â”€â”€ database/
â”‚   â”‚       â”œâ”€â”€ WaterDao.kt         # Database Access Object
â”‚   â”‚       â””â”€â”€ WaterDatabase.kt    # Room Database
â”‚   â””â”€â”€ repository/
â”‚       â””â”€â”€ WaterRepository.kt      # Repository (ë°ì´í„° ì¶”ìƒí™”)
â”‚
â”œâ”€â”€ domain/                         # ë„ë©”ì¸ ê³„ì¸µ
â”‚   â””â”€â”€ model/
â”‚       â””â”€â”€ DailyWaterIntake.kt     # ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸
â”‚
â”œâ”€â”€ presentation/                   # í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ
â”‚   â”œâ”€â”€ bluetooth/
â”‚   â”‚   â””â”€â”€ BluetoothManager.kt     # ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  ê´€ë¦¬
â”‚   â””â”€â”€ home/
â”‚       â”œâ”€â”€ HomeViewModel.kt        # ViewModel
â”‚       â””â”€â”€ HomeScreen.kt           # Compose UI
â”‚
â”œâ”€â”€ ui/                             # UI í…Œë§ˆ
â”‚   â””â”€â”€ theme/
â”‚       â”œâ”€â”€ Theme.kt                # Material3 í…Œë§ˆ
â”‚       â””â”€â”€ Type.kt                 # íƒ€ì´í¬ê·¸ë˜í”¼
â”‚
â””â”€â”€ MainActivity.kt                 # ë©”ì¸ ì•¡í‹°ë¹„í‹°
```

### 3.2 íŒŒì¼ë³„ ì—­í• 

| íŒŒì¼ | ë¼ì¸ ìˆ˜ | ì£¼ìš” ì—­í•  |
|-----|--------|----------|
| WaterRecord.kt | ~50 | ë°ì´í„°ë² ì´ìŠ¤ Entity ì •ì˜ |
| WaterDao.kt | ~100 | ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì •ì˜ |
| WaterDatabase.kt | ~50 | Room ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • |
| WaterRepository.kt | ~120 | ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™” |
| DailyWaterIntake.kt | ~80 | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ëª¨ë¸ |
| BluetoothManager.kt | ~300 | ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  ì „ì²´ |
| HomeViewModel.kt | ~130 | UI ìƒíƒœ ê´€ë¦¬ |
| HomeScreen.kt | ~350 | Compose UI êµ¬í˜„ |
| MainActivity.kt | ~20 | ì•± ì§„ì…ì  |

---

## 4. ì•„í‚¤í…ì²˜ ì„¤ëª…

### 4.1 MVVM íŒ¨í„´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              View (Compose)              â”‚
â”‚         HomeScreen.kt                    â”‚
â”‚  - UI ë Œë”ë§                              â”‚
â”‚  - ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ collectAsState()
               â”‚ ì´ë²¤íŠ¸ ì „ë‹¬
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ViewModel                      â”‚
â”‚         HomeViewModel.kt                 â”‚
â”‚  - UI ìƒíƒœ ê´€ë¦¬ (StateFlow)               â”‚
â”‚  - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í˜¸ì¶œ                      â”‚
â”‚  - ì´ë²¤íŠ¸ ì²˜ë¦¬                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Repository í˜¸ì¶œ
               â”‚ BluetoothManager í˜¸ì¶œ
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Model (Repository)            â”‚
â”‚  - WaterRepository.kt                    â”‚
â”‚  - BluetoothManager.kt                   â”‚
â”‚  - ë°ì´í„° ì†ŒìŠ¤ ì¶”ìƒí™”                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ DAO í˜¸ì¶œ
               â”‚ Bluetooth API í˜¸ì¶œ
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Data Source                     â”‚
â”‚  - Room Database                         â”‚
â”‚  - Bluetooth Classic API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Clean Architecture (3-Layer)

#### Layer 1: Data Layer (ë°ì´í„° ê³„ì¸µ)

```kotlin
ì—­í• : ë°ì´í„°ì˜ ì €ì¥, ì¡°íšŒ, ì™¸ë¶€ í†µì‹ 
êµ¬ì„± ìš”ì†Œ:
  - Entity (WaterRecord)
  - DAO (WaterDao)
  - Database (WaterDatabase)
  - Repository (WaterRepository)

ì±…ì„:
  - Room Database ì ‘ê·¼
  - ì¿¼ë¦¬ ì‹¤í–‰
  - ë°ì´í„° ë³€í™˜
```

#### Layer 2: Domain Layer (ë„ë©”ì¸ ê³„ì¸µ)

```kotlin
ì—­í• : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ìˆœìˆ˜ Kotlin í´ë˜ìŠ¤
êµ¬ì„± ìš”ì†Œ:
  - Model (DailyWaterIntake)
  - Enum (BluetoothConnectionState)

ì±…ì„:
  - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì •ì˜
  - ê³„ì‚° ë¡œì§ (ë‹¬ì„±ë¥ , ë‚¨ì€ ì–‘)
  - ë„ë©”ì¸ ëª¨ë¸ ì •ì˜
```

#### Layer 3: Presentation Layer (í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ)

```kotlin
ì—­í• : UI í‘œì‹œ, ì‚¬ìš©ì ìƒí˜¸ì‘ìš©
êµ¬ì„± ìš”ì†Œ:
  - ViewModel (HomeViewModel)
  - Compose UI (HomeScreen)
  - BluetoothManager

ì±…ì„:
  - UI ìƒíƒœ ê´€ë¦¬
  - ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
  - í™”ë©´ ë Œë”ë§
```

### 4.3 ì˜ì¡´ì„± ë°©í–¥

```
Presentation â†’ Domain â† Data
     â†“           â†‘         â†‘
  ViewModel   Model    Repository
     â†“                      â†“
     UI                 Database
```

**í•µì‹¬ ì›ì¹™:**
- ìƒìœ„ ê³„ì¸µì€ í•˜ìœ„ ê³„ì¸µì—ë§Œ ì˜ì¡´
- Domainì€ ë‹¤ë¥¸ ê³„ì¸µì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ (ìˆœìˆ˜ Kotlin)
- Dataì™€ Presentationì€ ì„œë¡œ ì§ì ‘ ì˜ì¡´í•˜ì§€ ì•ŠìŒ

---

## 5. ê³„ì¸µë³„ ìƒì„¸ ì„¤ëª…

### 5.1 Data Layer

#### 5.1.1 WaterRecord.kt (Entity)

```kotlin
@Entity(tableName = "water_records")
data class WaterRecord(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    val amount: Int,        // ë§ˆì‹  ì–‘ (ml)
    val timestamp: Long,    // íƒ€ì„ìŠ¤íƒ¬í”„ (ë°€ë¦¬ì´ˆ)
    val date: String        // ë‚ ì§œ (yyyy-MM-dd)
)
```

**ì—­í• :**
- Room Databaseì˜ í…Œì´ë¸” êµ¬ì¡° ì •ì˜
- í•œ ë²ˆì˜ ë¬¼ ì„­ì·¨ ê¸°ë¡ì„ ë‚˜íƒ€ëƒ„

**í•„ë“œ ì„¤ëª…:**
- `id`: ìë™ ì¦ê°€ Primary Key
- `amount`: ë§ˆì‹  ì–‘ (ml ë‹¨ìœ„)
- `timestamp`: ê¸°ë¡ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
- `date`: ë‚ ì§œ ë¬¸ìì—´ (ì§‘ê³„ìš©)

**íŠ¹ì§•:**
- `@Entity`: Roomì—ê²Œ í…Œì´ë¸”ì„ì„ ì•Œë¦¼
- `@PrimaryKey(autoGenerate = true)`: ìë™ ID ìƒì„±
- `data class`: ìë™ìœ¼ë¡œ equals, hashCode, copy ìƒì„±

#### 5.1.2 WaterDao.kt (Data Access Object)

```kotlin
@Dao
interface WaterDao {
    // ì‚½ì…
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(record: WaterRecord): Long

    // ì¡°íšŒ (Flow)
    @Query("SELECT * FROM water_records WHERE date = :date ORDER BY timestamp DESC")
    fun getRecordsByDate(date: String): Flow<List<WaterRecord>>

    // ì´ëŸ‰ ì¡°íšŒ
    @Query("SELECT COALESCE(SUM(amount), 0) FROM water_records WHERE date = :date")
    suspend fun getTotalAmountByDate(date: String): Int

    // ì‚­ì œ
    @Delete
    suspend fun delete(record: WaterRecord)
}
```

**ì—­í• :**
- ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì •ì˜
- CRUD ì‘ì—… ì¶”ìƒí™”

**ì£¼ìš” í•¨ìˆ˜:**

1. **insert()**: ìƒˆ ê¸°ë¡ ì¶”ê°€
   - `suspend`: ì½”ë£¨í‹´ì—ì„œ ì‹¤í–‰
   - `onConflict`: ì¤‘ë³µ ì‹œ ë®ì–´ì“°ê¸°
   - ë°˜í™˜ê°’: ì‚½ì…ëœ row ID

2. **getRecordsByDate()**: ë‚ ì§œë³„ ê¸°ë¡ ì¡°íšŒ
   - `Flow`: ë°˜ì‘í˜• ë°ì´í„° ìŠ¤íŠ¸ë¦¼
   - ë°ì´í„° ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
   - ìµœì‹ ìˆœ ì •ë ¬

3. **getTotalAmountByDate()**: ë‚ ì§œë³„ ì´ëŸ‰
   - `COALESCE`: NULLì„ 0ìœ¼ë¡œ ì²˜ë¦¬
   - `SUM`: í•©ê³„ ê³„ì‚°

**Flow vs Suspend:**
```kotlin
// Flow: ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
fun getData(): Flow<List<T>>  // ë°ì´í„° ë³€ê²½ ì‹œ ìë™ emit

// Suspend: ì¼íšŒì„± ì¡°íšŒ
suspend fun getData(): List<T>  // í•œ ë²ˆë§Œ ì¡°íšŒ
```

#### 5.1.3 WaterDatabase.kt

```kotlin
@Database(
    entities = [WaterRecord::class],
    version = 1,
    exportSchema = false
)
abstract class WaterDatabase : RoomDatabase() {
    abstract fun waterDao(): WaterDao

    companion object {
        @Volatile
        private var INSTANCE: WaterDatabase? = null

        fun getDatabase(context: Context): WaterDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    WaterDatabase::class.java,
                    "water_database"
                ).fallbackToDestructiveMigration().build()
                INSTANCE = instance
                instance
            }
        }
    }
}
```

**ì—­í• :**
- Room Database ì„¤ì •
- Singleton íŒ¨í„´ìœ¼ë¡œ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë³´ì¥

**ì£¼ìš” êµ¬ì„±:**

1. **@Database**: Room ì„¤ì •
   - `entities`: í¬í•¨í•  Entity ëª©ë¡
   - `version`: ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „
   - `exportSchema`: ìŠ¤í‚¤ë§ˆ íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì—¬ë¶€

2. **Singleton íŒ¨í„´:**
   ```kotlin
   @Volatile  // ë©€í‹° ìŠ¤ë ˆë“œ ì•ˆì „ì„±
   private var INSTANCE: WaterDatabase? = null

   synchronized(this) {  // ë™ì‹œ ìƒì„± ë°©ì§€
       // ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
   }
   ```

3. **fallbackToDestructiveMigration():**
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ ì‹œ ë°ì´í„° ì‚­ì œ í›„ ì¬ìƒì„±
   - ê°œë°œ ë‹¨ê³„ì—ì„œ ìœ ìš©

#### 5.1.4 WaterRepository.kt

```kotlin
class WaterRepository(private val waterDao: WaterDao) {

    // ê¸°ë¡ ì¶”ê°€
    suspend fun addWaterRecord(amount: Int): Long {
        val record = WaterRecord(amount = amount)
        return waterDao.insert(record)
    }

    // ì˜¤ëŠ˜ì˜ ì„­ì·¨ëŸ‰ (Flow)
    fun getTodayIntake(goalAmount: Int = 2000): Flow<DailyWaterIntake> {
        val today = getCurrentDate()
        return waterDao.getRecordsByDate(today).map { records ->
            DailyWaterIntake(
                date = today,
                totalAmount = records.sumOf { it.amount },
                goalAmount = goalAmount,
                recordCount = records.size
            )
        }
    }

    // ì£¼ê°„ í†µê³„
    suspend fun getWeeklyStats(goalAmount: Int = 2000): List<DailyWaterIntake> {
        // ë‚ ì§œ ê³„ì‚° ë° ë°ì´í„° ì¡°íšŒ
    }
}
```

**ì—­í• :**
- DAOì™€ ViewModel ì‚¬ì´ì˜ ì¶”ìƒí™” ê³„ì¸µ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
- ë°ì´í„° ë³€í™˜

**ì£¼ìš” í•¨ìˆ˜:**

1. **addWaterRecord():**
   - Entity ìƒì„± ë° ì €ì¥
   - ID ë°˜í™˜

2. **getTodayIntake():**
   - Flow ë³€í™˜ (List â†’ DailyWaterIntake)
   - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
   - ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ë¡œ ë³€í™˜

3. **getWeeklyStats():**
   - 7ì¼ ì¹˜ ë°ì´í„° ì§‘ê³„
   - ë¹ˆ ë‚ ì§œëŠ” 0ìœ¼ë¡œ ì±„ì›€
   - í†µê³„ ê³„ì‚°

**Flow ë³€í™˜ ì˜ˆì‹œ:**
```kotlin
// DAOì—ì„œ Flow<List<WaterRecord>> ë°›ìŒ
waterDao.getRecordsByDate(today)
    .map { records ->  // ë³€í™˜
        DailyWaterIntake(...)
    }
// ViewModelì—ì„œ Flow<DailyWaterIntake> ì‚¬ìš©
```

---

### 5.2 Domain Layer

#### 5.2.1 DailyWaterIntake.kt

```kotlin
data class DailyWaterIntake(
    val date: String,
    val totalAmount: Int,      // ì´ ì„­ì·¨ëŸ‰ (ml)
    val goalAmount: Int = 2000, // ëª©í‘œëŸ‰ (ml)
    val recordCount: Int = 0    // ê¸°ë¡ íšŸìˆ˜
) {
    // ê³„ì‚°ëœ ì†ì„±
    val achievementRate: Float
        get() = if (goalAmount > 0)
            (totalAmount.toFloat() / goalAmount).coerceIn(0f, 1f)
            else 0f

    val achievementPercent: Int
        get() = (achievementRate * 100).toInt()

    val isGoalAchieved: Boolean
        get() = totalAmount >= goalAmount

    val remainingAmount: Int
        get() = (goalAmount - totalAmount).coerceAtLeast(0)
}
```

**ì—­í• :**
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìº¡ìŠí™”
- UIì— í•„ìš”í•œ ê³„ì‚°ëœ ê°’ ì œê³µ
- ìˆœìˆ˜ Kotlin í´ë˜ìŠ¤ (Android ì˜ì¡´ì„± ì—†ìŒ)

**ê³„ì‚°ëœ ì†ì„±:**

1. **achievementRate**: ë‹¬ì„±ë¥  (0.0 ~ 1.0)
   ```kotlin
   ì˜ˆ: 1000ml / 2000ml = 0.5
   ```

2. **achievementPercent**: ë‹¬ì„±ë¥  (%)
   ```kotlin
   ì˜ˆ: 0.5 * 100 = 50%
   ```

3. **isGoalAchieved**: ëª©í‘œ ë‹¬ì„± ì—¬ë¶€
   ```kotlin
   ì˜ˆ: 2100ml >= 2000ml = true
   ```

4. **remainingAmount**: ë‚¨ì€ ì–‘
   ```kotlin
   ì˜ˆ: 2000ml - 1300ml = 700ml
   coerceAtLeast(0): ìŒìˆ˜ ë°©ì§€
   ```

**Enum ì •ì˜:**

```kotlin
enum class BluetoothConnectionState {
    DISCONNECTED,  // ì—°ê²° ì•ˆ ë¨
    CONNECTING,    // ì—°ê²° ì¤‘
    CONNECTED,     // ì—°ê²°ë¨
    ERROR          // ì˜¤ë¥˜
}
```

---

### 5.3 Presentation Layer

#### 5.3.1 BluetoothManager.kt

```kotlin
class BluetoothManager(private val context: Context) {

    private val bluetoothAdapter: BluetoothAdapter? = BluetoothAdapter.getDefaultAdapter()
    private var bluetoothSocket: BluetoothSocket? = null
    private var inputStream: InputStream? = null
    private var outputStream: OutputStream? = null

    // ìƒíƒœ Flow
    private val _connectionState = MutableStateFlow(BluetoothConnectionState.DISCONNECTED)
    val connectionState: StateFlow<BluetoothConnectionState> = _connectionState.asStateFlow()

    private val _currentWeight = MutableStateFlow(0f)
    val currentWeight: StateFlow<Float> = _currentWeight.asStateFlow()

    private val _drinkAmount = MutableStateFlow<Float?>(null)
    val drinkAmount: StateFlow<Float?> = _drinkAmount.asStateFlow()
}
```

**ì—­í• :**
- ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  ì „ì²´ ê´€ë¦¬
- ë°ì´í„° ìˆ˜ì‹  ë° íŒŒì‹±
- ëª…ë ¹ ì „ì†¡

**í•µì‹¬ êµ¬ì„± ìš”ì†Œ:**

1. **StateFlow**: ìƒíƒœ ê´€ë¦¬
   ```kotlin
   MutableStateFlow: ë‚´ë¶€ì—ì„œ ê°’ ë³€ê²½
   StateFlow: ì™¸ë¶€ì—ì„œ ì½ê¸°ë§Œ ê°€ëŠ¥
   ```

2. **BluetoothSocket**: í†µì‹  ì†Œì¼“
3. **InputStream/OutputStream**: ë°ì´í„° ì…ì¶œë ¥

**ì£¼ìš” í•¨ìˆ˜ (ìƒì„¸):**

##### connect() - ë””ë°”ì´ìŠ¤ ì—°ê²°

```kotlin
@SuppressLint("MissingPermission")
suspend fun connect(device: BluetoothDevice) = withContext(Dispatchers.IO) {
    try {
        _connectionState.value = BluetoothConnectionState.CONNECTING

        // 1. ì†Œì¼“ ìƒì„±
        bluetoothSocket = device.createRfcommSocketToServiceRecord(UUID_SPP)

        // 2. ì—°ê²°
        bluetoothSocket?.connect()

        // 3. ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™”
        inputStream = bluetoothSocket?.inputStream
        outputStream = bluetoothSocket?.outputStream

        _connectionState.value = BluetoothConnectionState.CONNECTED

        // 4. ë°ì´í„° ìˆ˜ì‹  ì‹œì‘
        startReading()

    } catch (e: IOException) {
        _connectionState.value = BluetoothConnectionState.ERROR
        disconnect()
    }
}
```

**ë™ì‘ ê³¼ì •:**
1. ìƒíƒœë¥¼ CONNECTINGìœ¼ë¡œ ë³€ê²½
2. SPP(Serial Port Profile) UUIDë¡œ ì†Œì¼“ ìƒì„±
3. ì†Œì¼“ ì—°ê²°
4. ì…ì¶œë ¥ ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™”
5. ìƒíƒœë¥¼ CONNECTEDë¡œ ë³€ê²½
6. ë°ì´í„° ì½ê¸° ì‹œì‘

##### startReading() - ë°ì´í„° ìˆ˜ì‹ 

```kotlin
private fun startReading() {
    readJob = scope.launch {
        val buffer = ByteArray(1024)
        val stringBuilder = StringBuilder()

        try {
            while (isActive && _connectionState.value == BluetoothConnectionState.CONNECTED) {
                // 1. ë°ì´í„° ì½ê¸°
                val bytes = inputStream?.read(buffer)
                if (bytes != null && bytes > 0) {
                    val data = String(buffer, 0, bytes)
                    stringBuilder.append(data)

                    // 2. ì¤„ë°”ê¿ˆìœ¼ë¡œ ë©”ì‹œì§€ ë¶„ë¦¬
                    val messages = stringBuilder.toString().split("\n")
                    stringBuilder.clear()

                    // 3. ë§ˆì§€ë§‰ ë¶ˆì™„ì „ ë©”ì‹œì§€ ì²˜ë¦¬
                    if (!data.endsWith("\n")) {
                        stringBuilder.append(messages.last())
                    }

                    // 4. ì™„ì „í•œ ë©”ì‹œì§€ë§Œ íŒŒì‹±
                    val completeMessages = if (data.endsWith("\n")) {
                        messages
                    } else {
                        messages.dropLast(1)
                    }

                    // 5. ê° ë©”ì‹œì§€ íŒŒì‹±
                    completeMessages.forEach { message ->
                        if (message.isNotBlank()) {
                            parseMessage(message.trim())
                        }
                    }
                }
            }
        } catch (e: IOException) {
            _connectionState.value = BluetoothConnectionState.ERROR
            disconnect()
        }
    }
}
```

**ë°ì´í„° ìˆ˜ì‹  í”„ë¡œì„¸ìŠ¤:**

1. **ë²„í¼ ì½ê¸°**: InputStreamì—ì„œ ë°”ì´íŠ¸ ì½ê¸°
2. **ë¬¸ìì—´ ë³€í™˜**: ë°”ì´íŠ¸ â†’ String
3. **ëˆ„ì **: StringBuilderì— ëˆ„ì 
4. **ë©”ì‹œì§€ ë¶„ë¦¬**: ì¤„ë°”ê¿ˆ(`\n`)ìœ¼ë¡œ ë¶„ë¦¬
5. **ë¶ˆì™„ì „ ë©”ì‹œì§€ ì²˜ë¦¬**: ë§ˆì§€ë§‰ ë¶€ë¶„ ë³´ê´€
6. **íŒŒì‹±**: ì™„ì „í•œ ë©”ì‹œì§€ë§Œ íŒŒì‹±

**ë²„í¼ë§ ì˜ˆì‹œ:**

```
ìˆ˜ì‹  1: "W:250.5\nD"  â†’ "W:250.5" íŒŒì‹±, "D" ë³´ê´€
ìˆ˜ì‹  2: ":50.0\n"     â†’ "D:50.0" íŒŒì‹±
```

##### parseMessage() - ë©”ì‹œì§€ íŒŒì‹±

```kotlin
private fun parseMessage(message: String) {
    when {
        message.startsWith(CMD_WEIGHT) -> {
            // "W:250.5" â†’ 250.5
            val weight = message.substring(CMD_WEIGHT.length).toFloatOrNull()
            if (weight != null) {
                _currentWeight.value = weight
            }
        }

        message.startsWith(CMD_DRINK) -> {
            // "D:50.0" â†’ 50.0
            val amount = message.substring(CMD_DRINK.length).toFloatOrNull()
            if (amount != null) {
                _drinkAmount.value = amount

                // ì´ë²¤íŠ¸ ì²˜ë¦¬ í›„ ë¦¬ì…‹
                scope.launch {
                    delay(1000)
                    _drinkAmount.value = null
                }
            }
        }

        message.startsWith(CMD_STATUS) -> {
            // "S:READY" â†’ "READY"
            val status = message.substring(CMD_STATUS.length)
            _statusMessage.value = status
        }
    }
}
```

**í”„ë¡œí† ì½œ íŒŒì‹±:**

| ëª…ë ¹ | í˜•ì‹ | íŒŒì‹± ê²°ê³¼ | StateFlow ì—…ë°ì´íŠ¸ |
|-----|------|----------|-------------------|
| W: | `W:250.5\n` | 250.5 | `_currentWeight` |
| D: | `D:50.0\n` | 50.0 | `_drinkAmount` |
| S: | `S:READY\n` | "READY" | `_statusMessage` |

**ì´ë²¤íŠ¸ ì²˜ë¦¬:**
- `drinkAmount`ëŠ” 1ì´ˆ í›„ ìë™ìœ¼ë¡œ nullë¡œ ë¦¬ì…‹
- ì´ìœ : ë‹¤ìŒ ì´ë²¤íŠ¸ ê°ì§€ë¥¼ ìœ„í•´

##### sendCommand() - ëª…ë ¹ ì „ì†¡

```kotlin
private suspend fun sendCommand(command: String) = withContext(Dispatchers.IO) {
    try {
        outputStream?.write("$command\n".toByteArray())
        outputStream?.flush()
    } catch (e: IOException) {
        _connectionState.value = BluetoothConnectionState.ERROR
    }
}

// ì˜ì  ì¡°ì •
suspend fun sendTareCommand() {
    sendCommand("T")
}

// ë¦¬ì…‹
suspend fun sendResetCommand() {
    sendCommand("R")
}
```

**ëª…ë ¹ ì „ì†¡ ê³¼ì •:**
1. ëª…ë ¹ ë¬¸ìì—´ì— `\n` ì¶”ê°€
2. ë°”ì´íŠ¸ ë°°ì—´ë¡œ ë³€í™˜
3. OutputStreamì— ì“°ê¸°
4. ë²„í¼ ë¹„ìš°ê¸° (flush)

---

#### 5.3.2 HomeViewModel.kt

```kotlin
class HomeViewModel(application: Application) : AndroidViewModel(application) {

    private val bluetoothManager = BluetoothManager(application)
    private val repository: WaterRepository

    init {
        val database = WaterDatabase.getDatabase(application)
        repository = WaterRepository(database.waterDao())
    }

    // StateFlow ë…¸ì¶œ
    val connectionState: StateFlow<BluetoothConnectionState> = bluetoothManager.connectionState
    val currentWeight: StateFlow<Float> = bluetoothManager.currentWeight
    val todayIntake: StateFlow<DailyWaterIntake> = repository.getTodayIntake(_goalAmount.value)
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5000),
            initialValue = DailyWaterIntake.empty(...)
        )

    // ì´ë²¤íŠ¸ ì²˜ë¦¬
    private val _uiEvent = MutableSharedFlow<UiEvent>()
    val uiEvent: SharedFlow<UiEvent> = _uiEvent.asSharedFlow()
}
```

**ì—­í• :**
- UI ìƒíƒœ ê´€ë¦¬
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í˜¸ì¶œ
- ì´ë²¤íŠ¸ ì²˜ë¦¬

**StateFlow vs SharedFlow:**

```kotlin
// StateFlow: ìƒíƒœ (í•­ìƒ ê°’ì´ ìˆìŒ)
val currentWeight: StateFlow<Float>
// êµ¬ë… ì¦‰ì‹œ í˜„ì¬ ê°’ ì „ë‹¬

// SharedFlow: ì´ë²¤íŠ¸ (ì¼íšŒì„±)
val uiEvent: SharedFlow<UiEvent>
// ë°œìƒ ì‹œì—ë§Œ ì „ë‹¬, êµ¬ë… ì „ ì´ë²¤íŠ¸ëŠ” ë†“ì¹¨
```

**StateFlow ë³€í™˜ (stateIn):**

```kotlin
repository.getTodayIntake(_goalAmount.value)  // Flow<DailyWaterIntake>
    .stateIn(
        scope = viewModelScope,        // ViewModel ìƒëª…ì£¼ê¸°
        started = SharingStarted.WhileSubscribed(5000),  // êµ¬ë… ì „ëµ
        initialValue = DailyWaterIntake.empty(...)       // ì´ˆê¸°ê°’
    )  // â†’ StateFlow<DailyWaterIntake>
```

**SharingStarted ì „ëµ:**
- `WhileSubscribed(5000)`: êµ¬ë…ìê°€ ìˆëŠ” ë™ì•ˆë§Œ í™œì„±í™”
- `5000ms`: ë§ˆì§€ë§‰ êµ¬ë…ìê°€ ë– ë‚œ í›„ 5ì´ˆê°„ ìœ ì§€
- ë©”ëª¨ë¦¬ ìµœì í™”

**ìë™ ê¸°ë¡ ë¡œì§:**

```kotlin
init {
    // BluetoothManagerì˜ drinkAmount ê°ì§€
    viewModelScope.launch {
        bluetoothManager.drinkAmount.collect { amount ->
            if (amount != null && amount > 0) {
                // ìë™ìœ¼ë¡œ ê¸°ë¡ ì¶”ê°€
                addWaterRecord(amount.toInt())
            }
        }
    }
}
```

**ë™ì‘ ê³¼ì •:**
1. BluetoothManagerì—ì„œ `D:50.0` ìˆ˜ì‹ 
2. `drinkAmount` StateFlowê°€ 50.0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
3. ViewModelì—ì„œ collectë¡œ ê°ì§€
4. `addWaterRecord(50)` í˜¸ì¶œ
5. Repositoryë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
6. Roomì˜ Flowê°€ ìë™ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸

**í•¨ìˆ˜ êµ¬í˜„:**

##### connectToDevice()

```kotlin
fun connectToDevice(device: BluetoothDevice) {
    viewModelScope.launch {
        try {
            bluetoothManager.connect(device)
            _uiEvent.emit(UiEvent.ShowMessage("${device.name}ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤"))
        } catch (e: Exception) {
            _uiEvent.emit(UiEvent.ShowError("ì—°ê²° ì‹¤íŒ¨: ${e.message}"))
        }
    }
}
```

**íŠ¹ì§•:**
- `viewModelScope.launch`: ViewModel ìƒëª…ì£¼ê¸°ì— ë§ì¶° ì‹¤í–‰
- `_uiEvent.emit()`: ì¼íšŒì„± ì´ë²¤íŠ¸ ë°œìƒ
- try-catch: ì˜ˆì™¸ ì²˜ë¦¬

##### addWaterRecord()

```kotlin
fun addWaterRecord(amount: Int) {
    viewModelScope.launch {
        try {
            repository.addWaterRecord(amount)
            _uiEvent.emit(UiEvent.RecordAdded(amount))
        } catch (e: Exception) {
            _uiEvent.emit(UiEvent.ShowError("ê¸°ë¡ ì¶”ê°€ ì‹¤íŒ¨: ${e.message}"))
        }
    }
}
```

**ìë™ UI ì—…ë°ì´íŠ¸:**
```
addWaterRecord(50)
    â†“
Repository.insert()
    â†“
Room Database ë³€ê²½
    â†“
Flow ìë™ emit
    â†“
StateFlow ì—…ë°ì´íŠ¸
    â†“
Compose recomposition
    â†“
UI ìë™ ê°±ì‹ 
```

---

#### 5.3.3 HomeScreen.kt (Compose UI)

```kotlin
@Composable
fun HomeScreen(
    viewModel: HomeViewModel = viewModel()
) {
    // State êµ¬ë…
    val connectionState by viewModel.connectionState.collectAsState()
    val currentWeight by viewModel.currentWeight.collectAsState()
    val todayIntake by viewModel.todayIntake.collectAsState()

    // ë¡œì»¬ State
    var showDeviceDialog by remember { mutableStateOf(false) }
    val snackbarHostState = remember { SnackbarHostState() }

    // ì´ë²¤íŠ¸ ì²˜ë¦¬
    LaunchedEffect(Unit) {
        viewModel.uiEvent.collect { event ->
            when (event) {
                is UiEvent.ShowMessage -> {
                    snackbarHostState.showSnackbar(event.message)
                }
                // ...
            }
        }
    }

    Scaffold(
        topBar = { ... },
        snackbarHost = { SnackbarHost(snackbarHostState) }
    ) { paddingValues ->
        Column { ... }
    }
}
```

**Compose í•µì‹¬ ê°œë…:**

##### collectAsState()

```kotlin
val currentWeight by viewModel.currentWeight.collectAsState()
```

**ë™ì‘:**
1. StateFlowë¥¼ Stateë¡œ ë³€í™˜
2. ê°’ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ recomposition íŠ¸ë¦¬ê±°
3. `by` í‚¤ì›Œë“œë¡œ ìë™ unwrap

**recomposition:**
```
StateFlow ê°’ ë³€ê²½
    â†“
collectAsState() ê°ì§€
    â†“
Composable í•¨ìˆ˜ ì¬ì‹¤í–‰
    â†“
UI ì—…ë°ì´íŠ¸
```

##### remember

```kotlin
var showDeviceDialog by remember { mutableStateOf(false) }
```

**ì—­í• :**
- recomposition ê°„ì— ê°’ ìœ ì§€
- `mutableStateOf`: ë³€ê²½ ê°€ëŠ¥í•œ ìƒíƒœ ìƒì„±
- recomposition íŠ¸ë¦¬ê±°

**without remember:**
```kotlin
var value = false  // recompositionë§ˆë‹¤ falseë¡œ ë¦¬ì…‹ë¨
```

**with remember:**
```kotlin
var value by remember { mutableStateOf(false) }  // ê°’ ìœ ì§€ë¨
```

##### LaunchedEffect

```kotlin
LaunchedEffect(Unit) {  // key: Unit (í•œ ë²ˆë§Œ ì‹¤í–‰)
    viewModel.uiEvent.collect { event ->
        // ì´ë²¤íŠ¸ ì²˜ë¦¬
    }
}
```

**ì—­í• :**
- Composableì—ì„œ suspend í•¨ìˆ˜ ì‹¤í–‰
- key ë³€ê²½ ì‹œ ì¬ì‹¤í–‰
- Composable ì œê±° ì‹œ ìë™ ì·¨ì†Œ

**key ë³€ê²½:**
```kotlin
LaunchedEffect(userId) {  // userId ë³€ê²½ ì‹œë§ˆë‹¤ ì‹¤í–‰
    loadUserData(userId)
}
```

##### Scaffold

```kotlin
Scaffold(
    topBar = { TopAppBar(...) },
    snackbarHost = { SnackbarHost(snackbarHostState) }
) { paddingValues ->
    // Content
}
```

**ì—­í• :**
- Material Design ë ˆì´ì•„ì›ƒ êµ¬ì¡°
- TopBar, BottomBar, FAB, Snackbar ìë™ ë°°ì¹˜
- paddingValuesë¡œ ê²¹ì¹¨ ë°©ì§€

**UI ì»´í¬ë„ŒíŠ¸:**

##### BluetoothConnectionCard

```kotlin
@Composable
fun BluetoothConnectionCard(
    connectionState: BluetoothConnectionState,
    connectedDeviceName: String?,
    onConnectClick: () -> Unit,
    onDisconnectClick: () -> Unit,
    onTareClick: () -> Unit
) {
    Card {
        Column {
            // ì—°ê²° ìƒíƒœ í‘œì‹œ
            ConnectionStatusChip(connectionState)

            // ì¡°ê±´ë¶€ ë Œë”ë§
            if (connectionState == BluetoothConnectionState.CONNECTED) {
                Button(onClick = onDisconnectClick) { Text("ì—°ê²° í•´ì œ") }
                Button(onClick = onTareClick) { Text("ì˜ì  ì¡°ì •") }
            } else {
                Button(onClick = onConnectClick) { Text("ë””ë°”ì´ìŠ¤ ì—°ê²°") }
            }
        }
    }
}
```

**ì¡°ê±´ë¶€ ë Œë”ë§:**
```kotlin
if (condition) {
    // ì¡°ê±´ ì°¸ì¼ ë•Œë§Œ ë Œë”ë§
} else {
    // ì¡°ê±´ ê±°ì§“ì¼ ë•Œ ë Œë”ë§
}
```

##### TodayIntakeCard

```kotlin
@Composable
fun TodayIntakeCard(
    intake: DailyWaterIntake,
    onAddClick: () -> Unit
) {
    Card {
        Column {
            // ì§„í–‰ë¥  ë°”
            LinearProgressIndicator(
                progress = { intake.achievementRate }
            )

            // ì„­ì·¨ëŸ‰ í‘œì‹œ
            Text("${intake.totalAmount} / ${intake.goalAmount} ml")

            // ë‹¬ì„±ë¥ 
            Text("${intake.achievementPercent}%")

            // ì¡°ê±´ë¶€ ë©”ì‹œì§€
            if (!intake.isGoalAchieved) {
                Text("ëª©í‘œê¹Œì§€ ${intake.remainingAmount}ml ë‚¨ì•˜ìŠµë‹ˆë‹¤")
            } else {
                Text("ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!")
            }
        }
    }
}
```

**ë°˜ì‘í˜• UI:**
```
intake.achievementRate ë³€ê²½
    â†“
LinearProgressIndicator ìë™ ì—…ë°ì´íŠ¸
    â†“
ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
```

##### DeviceSelectionDialog

```kotlin
@Composable
fun DeviceSelectionDialog(
    devices: List<BluetoothDevice>,
    onDeviceSelected: (BluetoothDevice) -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("ë¸”ë£¨íˆ¬ìŠ¤ ë””ë°”ì´ìŠ¤ ì„ íƒ") },
        text = {
            LazyColumn {
                items(devices) { device ->
                    TextButton(
                        onClick = { onDeviceSelected(device) }
                    ) {
                        Text(device.name ?: device.address)
                    }
                }
            }
        }
    )
}
```

**LazyColumn:**
- RecyclerViewì˜ Compose ë²„ì „
- í•„ìš”í•œ ë§Œí¼ë§Œ ë Œë”ë§ (ì„±ëŠ¥ ìµœì í™”)
- `items()`: ë¦¬ìŠ¤íŠ¸ í•­ëª© ë Œë”ë§

---

## 6. ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ë™ì‘ ì›ë¦¬

### 6.1 ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° íë¦„

```
[ì‚¬ìš©ì]
   â†“ "ë””ë°”ì´ìŠ¤ ì—°ê²°" ë²„íŠ¼ í´ë¦­
[HomeScreen]
   â†“ onConnectClick()
[HomeViewModel]
   â†“ connectToDevice(device)
[BluetoothManager]
   â†“ connect(device)
[Android Bluetooth API]
   â†“ createRfcommSocketToServiceRecord()
   â†“ socket.connect()
[HC-05/06]
   â†“ ì—°ê²° ì„±ê³µ
[BluetoothManager]
   â†“ _connectionState.value = CONNECTED
   â†“ startReading()
[HomeViewModel]
   â†“ connectionState Flow ì—…ë°ì´íŠ¸
[HomeScreen]
   â†“ collectAsState() ê°ì§€
   â†“ Recomposition
[UI]
   â†“ "ì—°ê²°ë¨" í‘œì‹œ
```

### 6.2 ìë™ ì„­ì·¨ ê°ì§€ íë¦„

```
[Arduino]
   â†“ ë¬´ê²Œ ë³€í™” ê°ì§€ (250g â†’ 200g)
   â†“ "D:50.0\n" ì „ì†¡
[HC-05/06]
   â†“ Bluetooth ì „ì†¡
[BluetoothManager]
   â†“ inputStream.read()
   â†“ parseMessage("D:50.0")
   â†“ _drinkAmount.value = 50.0
[HomeViewModel]
   â†“ drinkAmount.collect { 50.0 }
   â†“ addWaterRecord(50)
[WaterRepository]
   â†“ WaterRecord(amount=50) ìƒì„±
   â†“ waterDao.insert(record)
[Room Database]
   â†“ INSERT INTO water_records ...
   â†“ Flow ìë™ emit
[WaterRepository]
   â†“ getTodayIntake() Flow ì—…ë°ì´íŠ¸
[HomeViewModel]
   â†“ todayIntake StateFlow ì—…ë°ì´íŠ¸
[HomeScreen]
   â†“ collectAsState() ê°ì§€
   â†“ Recomposition
[UI]
   â†“ ì„­ì·¨ëŸ‰ ìë™ ì—…ë°ì´íŠ¸ (0ml â†’ 50ml)
   â†“ ì§„í–‰ë¥  ë°” ì• ë‹ˆë©”ì´ì…˜
   â†“ Snackbar "50ml ê¸°ë¡ë¨"
```

### 6.3 ë°ì´í„°ë² ì´ìŠ¤ ì½ê¸° íë¦„

```
[HomeViewModel ì´ˆê¸°í™”]
   â†“
[Repository.getTodayIntake()]
   â†“
[WaterDao.getRecordsByDate(today)]
   â†“ Flow<List<WaterRecord>>
[Repository]
   â†“ .map { records -> DailyWaterIntake(...) }
   â†“ Flow<DailyWaterIntake>
[HomeViewModel]
   â†“ .stateIn(...) â†’ StateFlow
[HomeScreen]
   â†“ collectAsState()
   â†“ State<DailyWaterIntake>
[UI]
   â†“ ì´ˆê¸° ë Œë”ë§

// ë°ì´í„° ë³€ê²½ ì‹œ
[ìƒˆ ê¸°ë¡ ì¶”ê°€]
   â†“
[Room Database ë³€ê²½]
   â†“
[Flow ìë™ emit]
   â†“
[Repository map ì¬ì‹¤í–‰]
   â†“
[StateFlow ì—…ë°ì´íŠ¸]
   â†“
[Recomposition]
   â†“
[UI ìë™ ê°±ì‹ ]
```

---

## 7. ë°ì´í„° íë¦„

### 7.1 ë‹¨ë°©í–¥ ë°ì´í„° í”Œë¡œìš° (UDF)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           User Action                â”‚
â”‚     (ë²„íŠ¼ í´ë¦­, ì…ë ¥ ë“±)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ViewModel                  â”‚
â”‚   - ì´ë²¤íŠ¸ ì²˜ë¦¬                       â”‚
â”‚   - Repository í˜¸ì¶œ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Repository                  â”‚
â”‚   - ë°ì´í„° ì €ì¥/ì¡°íšŒ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Database / API               â”‚
â”‚   - ì‹¤ì œ ë°ì´í„° ë³€ê²½                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Flow                      â”‚
â”‚   - ìë™ ë°ì´í„° emit                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          StateFlow                   â”‚
â”‚   - UI ìƒíƒœ ì—…ë°ì´íŠ¸                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Compose                   â”‚
â”‚   - Recomposition                    â”‚
â”‚   - UI ë Œë”ë§                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ì›ì¹™:**
- ë°ì´í„°ëŠ” í•œ ë°©í–¥ìœ¼ë¡œë§Œ íë¦„
- UIëŠ” ìƒíƒœë§Œ ë°˜ì˜ (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—†ìŒ)
- ì‚¬ìš©ì ì•¡ì…˜ì€ ViewModelë¡œ ì „ë‹¬

### 7.2 ìƒíƒœ ê´€ë¦¬ ê³„ì¸µ

```
UI Layer (Compose)
  â””â”€ State (by collectAsState)
       â””â”€ StateFlow (ì½ê¸° ì „ìš©)
            â””â”€ MutableStateFlow (ViewModel ë‚´ë¶€)
                 â””â”€ Flow (Repository)
                      â””â”€ Room Database Query
```

---

## 8. ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  ë©”ì»¤ë‹ˆì¦˜

### 8.1 í”„ë¡œí† ì½œ ìƒì„¸

#### 8.1.1 Arduino â†’ App

| ëª…ë ¹ | í˜•ì‹ | ì„¤ëª… | ë¹ˆë„ |
|-----|------|------|------|
| W: | `W:250.5\n` | í˜„ì¬ ë¬´ê²Œ (g) | 500msë§ˆë‹¤ |
| D: | `D:50.0\n` | ë§ˆì‹  ì–‘ (ml) | ê°ì§€ ì‹œ |
| S: | `S:READY\n` | ìƒíƒœ ë©”ì‹œì§€ | ì´ë²¤íŠ¸ ì‹œ |

**ì „ì†¡ ì˜ˆì‹œ:**
```
W:0.0
W:0.5
W:0.2
S:CUP_ON
W:253.5
W:253.2
D:50.0
W:203.1
```

#### 8.1.2 App â†’ Arduino

| ëª…ë ¹ | í˜•ì‹ | ì„¤ëª… | ì‘ë‹µ |
|-----|------|------|------|
| T | `T\n` | ì˜ì  ì¡°ì • | `S:TARING\nS:TARE_OK\n` |
| R | `R\n` | ì‹œìŠ¤í…œ ë¦¬ì…‹ | `S:RESETTING\nS:RESET_OK\n` |

### 8.2 ë²„í¼ë§ ë° íŒŒì‹± ì „ëµ

#### ë¬¸ì œ: ë°ì´í„° ë¶„í•  ìˆ˜ì‹ 

```
ì „ì†¡: "W:250.5\nD:50.0\n"

ì‹¤ì œ ìˆ˜ì‹ :
ìˆ˜ì‹  1: "W:25"
ìˆ˜ì‹  2: "0.5\nD:"
ìˆ˜ì‹  3: "50.0\n"
```

#### í•´ê²°: StringBuilder + ì¤„ë°”ê¿ˆ ë¶„ë¦¬

```kotlin
val stringBuilder = StringBuilder()

while (true) {
    val data = readFromStream()  // "W:25"
    stringBuilder.append(data)    // "W:25"

    if (data.contains("\n")) {
        val messages = stringBuilder.split("\n")
        // ì™„ì „í•œ ë©”ì‹œì§€ë§Œ ì²˜ë¦¬
        // ë¶ˆì™„ì „í•œ ë§ˆì§€ë§‰ ë¶€ë¶„ì€ ë³´ê´€
    }
}
```

#### ìƒíƒœ ë¨¸ì‹ 

```
State 0: ëŒ€ê¸°
  â†“ "W" ìˆ˜ì‹ 
State 1: ëª…ë ¹ ì½ê¸°ì¤‘
  â†“ ":" ìˆ˜ì‹ 
State 2: ë°ì´í„° ì½ê¸°ì¤‘
  â†“ "\n" ìˆ˜ì‹ 
State 3: íŒŒì‹±
  â†“
State 0: ëŒ€ê¸°
```

### 8.3 ì—ëŸ¬ ì²˜ë¦¬

```kotlin
try {
    inputStream?.read(buffer)
} catch (e: IOException) {
    // ì—°ê²° ëŠê¹€
    _connectionState.value = BluetoothConnectionState.ERROR
    disconnect()
}
```

**ë°œìƒ ê°€ëŠ¥í•œ ì—ëŸ¬:**
- IOException: ì—°ê²° ëŠê¹€
- SecurityException: ê¶Œí•œ ì—†ìŒ
- NullPointerException: ì†Œì¼“/ìŠ¤íŠ¸ë¦¼ null

---

## 9. UI/UX êµ¬í˜„

### 9.1 Compose êµ¬ì¡°

```
HomeScreen
â”œâ”€ Scaffold
â”‚  â”œâ”€ TopAppBar
â”‚  â”‚  â””â”€ "ë¬¼ ì„­ì·¨ëŸ‰ ëª¨ë‹ˆí„°"
â”‚  â”œâ”€ SnackbarHost
â”‚  â””â”€ Column
â”‚     â”œâ”€ BluetoothConnectionCard
â”‚     â”‚  â”œâ”€ ConnectionStatusChip
â”‚     â”‚  â”œâ”€ Button (ì—°ê²°/í•´ì œ)
â”‚     â”‚  â””â”€ Button (ì˜ì  ì¡°ì •)
â”‚     â”œâ”€ CurrentWeightCard
â”‚     â”‚  â””â”€ Text (ë¬´ê²Œ í‘œì‹œ)
â”‚     â””â”€ TodayIntakeCard
â”‚        â”œâ”€ LinearProgressIndicator
â”‚        â”œâ”€ Text (ì„­ì·¨ëŸ‰/ëª©í‘œëŸ‰)
â”‚        â””â”€ IconButton (ìˆ˜ë™ ì¶”ê°€)
â””â”€ Dialog (ì¡°ê±´ë¶€)
   â”œâ”€ DeviceSelectionDialog
   â””â”€ AddWaterDialog
```

### 9.2 Material3 ë””ìì¸

#### Color Scheme

```kotlin
// Light Theme
primary = Color(0xFF1976D2)      // íŒŒë€ìƒ‰
secondary = Color(0xFF00ACC1)    // ì²­ë¡ìƒ‰
tertiary = Color(0xFF388E3C)     // ì´ˆë¡ìƒ‰

// Dark Theme
primary = Color(0xFF90CAF9)      // ë°ì€ íŒŒë€ìƒ‰
secondary = Color(0xFF80DEEA)    // ë°ì€ ì²­ë¡ìƒ‰
tertiary = Color(0xFFA5D6A7)     // ë°ì€ ì´ˆë¡ìƒ‰
```

#### Typography

```kotlin
bodyLarge = TextStyle(
    fontSize = 16.sp,
    lineHeight = 24.sp,
    letterSpacing = 0.5.sp
)

titleLarge = TextStyle(
    fontSize = 22.sp,
    lineHeight = 28.sp
)
```

### 9.3 ì• ë‹ˆë©”ì´ì…˜

#### LinearProgressIndicator

```kotlin
LinearProgressIndicator(
    progress = { intake.achievementRate }  // 0.0 ~ 1.0
)
```

**ì• ë‹ˆë©”ì´ì…˜:**
- ì§„í–‰ë¥  ë³€ê²½ ì‹œ ìë™ ì• ë‹ˆë©”ì´ì…˜
- Material Design ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜ ì ìš©

#### Snackbar

```kotlin
snackbarHostState.showSnackbar("50ml ê¸°ë¡ë¨")
```

**ì• ë‹ˆë©”ì´ì…˜:**
- í•˜ë‹¨ì—ì„œ ìŠ¬ë¼ì´ë“œ ì—…
- ì¼ì • ì‹œê°„ í›„ ìë™ ì‚¬ë¼ì§

---

## 10. í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ ë¶„ì„

### 10.1 ì‹¤ì‹œê°„ ë¬´ê²Œ í‘œì‹œ

**ì½”ë“œ ê²½ë¡œ:**
```
BluetoothManager.startReading()
    â†’ parseMessage("W:250.5")
    â†’ _currentWeight.value = 250.5
    â†’ HomeViewModel.currentWeight (StateFlow)
    â†’ HomeScreen.collectAsState()
    â†’ CurrentWeightCard(currentWeight)
```

**UI ì—…ë°ì´íŠ¸ ì£¼ê¸°:**
- Arduino: 500msë§ˆë‹¤ ì „ì†¡
- ì•±: ìˆ˜ì‹  ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
- Compose: Recomposition ìµœì í™”

**ìµœì í™”:**
```kotlin
// Recomposition ë²”ìœ„ ìµœì†Œí™”
@Composable
fun CurrentWeightCard(currentWeight: Float) {
    // ì´ Composableë§Œ recompose
    Text("%.1f g".format(currentWeight))
}
```

### 10.2 ìë™ ì„­ì·¨ ê°ì§€

**ì•Œê³ ë¦¬ì¦˜ (Arduino):**

```cpp
1. ì»µ ê°ì§€ (10g ì´ìƒ)
2. ê¸°ì¤€ ë¬´ê²Œ ì„¤ì • (baselineWeight)
3. í˜„ì¬ ë¬´ê²Œ ëª¨ë‹ˆí„°ë§
4. ë¬´ê²Œ ê°ì†Œ ê°ì§€ (ì„ê³„ê°’ 5g ì´ìƒ)
5. ì•ˆì •í™” í™•ì¸ (5íšŒ ì—°ì†)
6. ë§ˆì‹  ì–‘ ê³„ì‚° ë° ì „ì†¡
```

**ì•± ì²˜ë¦¬:**

```kotlin
// 1. ë°ì´í„° ìˆ˜ì‹ 
parseMessage("D:50.0")
_drinkAmount.value = 50.0

// 2. ViewModelì—ì„œ ê°ì§€
bluetoothManager.drinkAmount.collect { amount ->
    if (amount != null && amount > 0) {
        addWaterRecord(amount.toInt())
    }
}

// 3. ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
repository.addWaterRecord(50)

// 4. Flow ìë™ ì—…ë°ì´íŠ¸
todayIntake StateFlow ë³€ê²½

// 5. UI ìë™ ê°±ì‹ 
TodayIntakeCard recomposition
```

**íƒ€ì´ë° ë‹¤ì´ì–´ê·¸ë¨:**

```
t=0ms    Arduino: ë¬´ê²Œ ê°ì†Œ ê°ì§€
t=10ms   Arduino: "D:50.0\n" ì „ì†¡
t=20ms   App: ë°ì´í„° ìˆ˜ì‹ 
t=25ms   App: parseMessage()
t=30ms   App: StateFlow ì—…ë°ì´íŠ¸
t=35ms   App: addWaterRecord() ì‹œì‘
t=50ms   App: Database INSERT
t=55ms   App: Flow emit
t=60ms   App: UI Recomposition
t=65ms   App: Snackbar í‘œì‹œ
```

### 10.3 ë°ì´í„° ì˜êµ¬ ì €ì¥

**ì €ì¥ í”„ë¡œì„¸ìŠ¤:**

```kotlin
// 1. ViewModel
fun addWaterRecord(amount: Int) {
    viewModelScope.launch {  // ì½”ë£¨í‹´ ì‹¤í–‰
        repository.addWaterRecord(amount)
    }
}

// 2. Repository
suspend fun addWaterRecord(amount: Int): Long {
    val record = WaterRecord(
        amount = amount,
        timestamp = System.currentTimeMillis(),
        date = getCurrentDate()
    )
    return waterDao.insert(record)
}

// 3. DAO
@Insert(onConflict = OnConflictStrategy.REPLACE)
suspend fun insert(record: WaterRecord): Long

// 4. Roomì´ ìë™ìœ¼ë¡œ SQL ìƒì„±
INSERT INTO water_records (amount, timestamp, date) VALUES (50, 1704700000000, '2025-01-08')
```

**ë°ì´í„° ë¬´ê²°ì„±:**
```kotlin
@Transaction  // Roomì—ì„œ ìë™ ì§€ì›
suspend fun complexOperation() {
    // ì—¬ëŸ¬ ì‘ì—…ì„ ì›ìì ìœ¼ë¡œ ì‹¤í–‰
    insert(...)
    update(...)
    // í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ëª¨ë‘ ë¡¤ë°±
}
```

### 10.4 ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°

**DailyWaterIntake ëª¨ë¸:**

```kotlin
data class DailyWaterIntake(
    val totalAmount: Int = 1300,  // í˜„ì¬ ì„­ì·¨ëŸ‰
    val goalAmount: Int = 2000     // ëª©í‘œëŸ‰
) {
    val achievementRate: Float
        get() = (totalAmount.toFloat() / goalAmount).coerceIn(0f, 1f)

    val achievementPercent: Int
        get() = (achievementRate * 100).toInt()

    val remainingAmount: Int
        get() = (goalAmount - totalAmount).coerceAtLeast(0)
}
```

**ê³„ì‚° ì˜ˆì‹œ:**

```kotlin
val intake = DailyWaterIntake(
    totalAmount = 1300,
    goalAmount = 2000
)

intake.achievementRate    // 0.65 (1300 / 2000)
intake.achievementPercent // 65 (0.65 * 100)
intake.remainingAmount    // 700 (2000 - 1300)
```

**UI ë°˜ì˜:**

```kotlin
// ì§„í–‰ë¥  ë°”
LinearProgressIndicator(
    progress = { intake.achievementRate }  // 0.65 â†’ 65% ì±„ì›€
)

// í…ìŠ¤íŠ¸
Text("${intake.totalAmount} / ${intake.goalAmount} ml")  // "1300 / 2000 ml"
Text("${intake.achievementPercent}%")  // "65%"
```

---

## 11. ì½”ë“œ ì˜ˆì‹œ ë° ë¶„ì„

### 11.1 StateFlow ì‚¬ìš© ì˜ˆì‹œ

```kotlin
// BluetoothManager
class BluetoothManager {
    // Private MutableStateFlow (ë‚´ë¶€ì—ì„œë§Œ ìˆ˜ì •)
    private val _connectionState = MutableStateFlow(BluetoothConnectionState.DISCONNECTED)

    // Public StateFlow (ì™¸ë¶€ì—ì„œ ì½ê¸°ë§Œ)
    val connectionState: StateFlow<BluetoothConnectionState> = _connectionState.asStateFlow()

    // ë‚´ë¶€ì—ì„œ ê°’ ë³€ê²½
    fun connect() {
        _connectionState.value = BluetoothConnectionState.CONNECTING
        // ...
        _connectionState.value = BluetoothConnectionState.CONNECTED
    }
}

// HomeViewModel
class HomeViewModel {
    // BluetoothManagerì˜ StateFlowë¥¼ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
    val connectionState: StateFlow<BluetoothConnectionState> = bluetoothManager.connectionState
}

// HomeScreen (Compose)
@Composable
fun HomeScreen(viewModel: HomeViewModel) {
    // StateFlowë¥¼ Stateë¡œ ë³€í™˜
    val connectionState by viewModel.connectionState.collectAsState()

    // ê°’ ì‚¬ìš©
    when (connectionState) {
        BluetoothConnectionState.CONNECTED -> Text("ì—°ê²°ë¨")
        BluetoothConnectionState.CONNECTING -> Text("ì—°ê²° ì¤‘")
        // ...
    }
}
```

**íë¦„:**
```
BluetoothManager._connectionState (MutableStateFlow)
    â†“ value ë³€ê²½
BluetoothManager.connectionState (StateFlow)
    â†“ ë³€ê²½ ì „íŒŒ
HomeViewModel.connectionState (StateFlow)
    â†“ collectAsState()
HomeScreen.connectionState (State)
    â†“ Recomposition
UI ì—…ë°ì´íŠ¸
```

### 11.2 Flow ë³€í™˜ ì˜ˆì‹œ

```kotlin
// DAO
@Query("SELECT * FROM water_records WHERE date = :date")
fun getRecordsByDate(date: String): Flow<List<WaterRecord>>

// Repository
fun getTodayIntake(goalAmount: Int): Flow<DailyWaterIntake> {
    val today = getCurrentDate()

    return waterDao.getRecordsByDate(today)  // Flow<List<WaterRecord>>
        .map { records ->  // ë³€í™˜
            DailyWaterIntake(
                date = today,
                totalAmount = records.sumOf { it.amount },
                goalAmount = goalAmount,
                recordCount = records.size
            )
        }  // Flow<DailyWaterIntake>
}

// ViewModel
val todayIntake: StateFlow<DailyWaterIntake> =
    repository.getTodayIntake(2000)  // Flow<DailyWaterIntake>
        .stateIn(  // Flow â†’ StateFlow ë³€í™˜
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5000),
            initialValue = DailyWaterIntake.empty("2025-01-08", 2000)
        )
```

**ë³€í™˜ ê³¼ì •:**

```
Database: List<WaterRecord>
    â†“ Flow<List<WaterRecord>>
Repository: map ë³€í™˜
    â†“ Flow<DailyWaterIntake>
ViewModel: stateIn
    â†“ StateFlow<DailyWaterIntake>
Compose: collectAsState
    â†“ State<DailyWaterIntake>
UI: ë Œë”ë§
```

### 11.3 Compose ìƒíƒœ ê´€ë¦¬ ì˜ˆì‹œ

```kotlin
@Composable
fun HomeScreen() {
    // ViewModelì—ì„œ StateFlow êµ¬ë…
    val todayIntake by viewModel.todayIntake.collectAsState()

    // ë¡œì»¬ State (ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ ì—¬ë¶€)
    var showDialog by remember { mutableStateOf(false) }

    // UI
    Column {
        // todayIntake ê°’ ì‚¬ìš©
        Text("${todayIntake.totalAmount} ml")

        // ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì»¬ ìƒíƒœ ë³€ê²½
        Button(onClick = { showDialog = true }) {
            Text("ê¸°ë¡ ì¶”ê°€")
        }
    }

    // ì¡°ê±´ë¶€ ë Œë”ë§
    if (showDialog) {
        AddWaterDialog(
            onConfirm = { amount ->
                viewModel.addWaterRecord(amount)  // ViewModel í˜¸ì¶œ
                showDialog = false  // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
            },
            onDismiss = { showDialog = false }
        )
    }
}
```

**ìƒíƒœ ë³€ê²½ íë¦„:**

```
1. ì‚¬ìš©ìê°€ "ê¸°ë¡ ì¶”ê°€" ë²„íŠ¼ í´ë¦­
    â†“
2. showDialog = true
    â†“
3. Recomposition
    â†“
4. AddWaterDialog ë Œë”ë§
    â†“
5. ì‚¬ìš©ìê°€ 100ml ì…ë ¥ í›„ í™•ì¸
    â†“
6. viewModel.addWaterRecord(100) í˜¸ì¶œ
    â†“
7. Repository â†’ Database ì €ì¥
    â†“
8. Flow ìë™ emit
    â†“
9. todayIntake StateFlow ì—…ë°ì´íŠ¸
    â†“
10. Recomposition (ìë™)
    â†“
11. Text ì—…ë°ì´íŠ¸ (0ml â†’ 100ml)
```

### 11.4 ì½”ë£¨í‹´ ì‚¬ìš© ì˜ˆì‹œ

```kotlin
// ViewModel
class HomeViewModel : ViewModel() {

    // viewModelScope: ViewModel ìƒëª…ì£¼ê¸°ì— ë§ì¶° ìë™ ì·¨ì†Œ
    fun connectToDevice(device: BluetoothDevice) {
        viewModelScope.launch {  // ì½”ë£¨í‹´ ì‹œì‘
            try {
                // suspend í•¨ìˆ˜ í˜¸ì¶œ
                bluetoothManager.connect(device)

                // UI ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ (Dispatchers.Main)
                _uiEvent.emit(UiEvent.ShowMessage("ì—°ê²° ì„±ê³µ"))

            } catch (e: Exception) {
                _uiEvent.emit(UiEvent.ShowError("ì—°ê²° ì‹¤íŒ¨"))
            }
        }
    }

    // init ë¸”ë¡ì—ì„œë„ ì‚¬ìš©
    init {
        viewModelScope.launch {
            bluetoothManager.drinkAmount.collect { amount ->
                if (amount != null) {
                    addWaterRecord(amount.toInt())
                }
            }
        }
    }
}

// BluetoothManager
class BluetoothManager {
    private val scope = CoroutineScope(Dispatchers.IO + SupervisorJob())

    // suspend í•¨ìˆ˜
    suspend fun connect(device: BluetoothDevice) = withContext(Dispatchers.IO) {
        // IO ì‘ì—…
        bluetoothSocket = device.createRfcommSocketToServiceRecord(UUID_SPP)
        bluetoothSocket?.connect()

        // ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹œì‘
        startReading()
    }

    private fun startReading() {
        scope.launch {  // IO ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
            while (isActive) {
                val bytes = inputStream?.read(buffer)
                // ë°ì´í„° ì²˜ë¦¬
            }
        }
    }
}
```

**Dispatchers:**

```kotlin
Dispatchers.Main    // UI ìŠ¤ë ˆë“œ
Dispatchers.IO      // ë„¤íŠ¸ì›Œí¬, íŒŒì¼ I/O
Dispatchers.Default // CPU ì§‘ì•½ì  ì‘ì—…
```

**ìƒëª…ì£¼ê¸°:**

```
ViewModel ìƒì„±
    â†“
viewModelScope ìƒì„±
    â†“
launch { ... } ì‹œì‘
    â†“
ViewModel onCleared()
    â†“
viewModelScope ìë™ ì·¨ì†Œ
    â†“
ëª¨ë“  ì½”ë£¨í‹´ ì¤‘ì§€
```

---

## 12. í™•ì¥ í¬ì¸íŠ¸

### 12.1 Phase 2 êµ¬í˜„ ê°€ì´ë“œ

#### í†µê³„ í™”ë©´ ì¶”ê°€

```kotlin
// 1. ViewModel ì¶”ê°€
class StatisticsViewModel : ViewModel() {
    val weeklyStats: StateFlow<List<DailyWaterIntake>>
    val averageIntake: StateFlow<Float>
}

// 2. Screen ì¶”ê°€
@Composable
fun StatisticsScreen(viewModel: StatisticsViewModel) {
    // ê·¸ë˜í”„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (MPAndroidChart)
}

// 3. Navigation ì¶”ê°€
NavHost {
    composable("home") { HomeScreen() }
    composable("statistics") { StatisticsScreen() }
}
```

#### ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€

```kotlin
// 1. WorkManager ì„¤ì •
class WaterReminderWorker : Worker() {
    override fun doWork(): Result {
        showNotification("ë¬¼ ë§ˆì‹¤ ì‹œê°„ì…ë‹ˆë‹¤!")
        return Result.success()
    }
}

// 2. ìŠ¤ì¼€ì¤„ë§
WorkManager.getInstance(context).enqueueUniquePeriodicWork(
    "water_reminder",
    ExistingPeriodicWorkPolicy.KEEP,
    PeriodicWorkRequestBuilder<WaterReminderWorker>(1, TimeUnit.HOURS).build()
)

// 3. NotificationHelper
class NotificationHelper(context: Context) {
    fun showNotification(message: String) {
        // ì•Œë¦¼ ìƒì„±
    }
}
```

### 12.2 í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

#### Repository íŒ¨í„´ í™œìš©

```kotlin
// ì¸í„°í˜ì´ìŠ¤ ì •ì˜
interface WaterDataSource {
    fun getTodayIntake(): Flow<DailyWaterIntake>
    suspend fun addRecord(amount: Int)
}

// Local êµ¬í˜„
class LocalWaterDataSource(private val dao: WaterDao) : WaterDataSource {
    // Room ì‚¬ìš©
}

// Remote êµ¬í˜„ (í–¥í›„)
class RemoteWaterDataSource(private val api: ApiService) : WaterDataSource {
    // í´ë¼ìš°ë“œ ë™ê¸°í™”
}

// RepositoryëŠ” ì¶”ìƒí™” ì‚¬ìš©
class WaterRepository(
    private val localDataSource: WaterDataSource,
    private val remoteDataSource: WaterDataSource? = null
) {
    // í•„ìš”ì— ë”°ë¼ local ë˜ëŠ” remote ì‚¬ìš©
}
```

#### ViewModel í™•ì¥

```kotlin
// BaseViewModel
abstract class BaseViewModel : ViewModel() {
    protected val _uiEvent = MutableSharedFlow<UiEvent>()
    val uiEvent = _uiEvent.asSharedFlow()

    protected suspend fun emitEvent(event: UiEvent) {
        _uiEvent.emit(event)
    }
}

// ìƒì†
class HomeViewModel : BaseViewModel() {
    // ê³µí†µ ê¸°ëŠ¥ ì‚¬ìš©
}
```

### 12.3 í…ŒìŠ¤íŠ¸ ì‘ì„± ê°€ì´ë“œ

```kotlin
// Repository í…ŒìŠ¤íŠ¸
class WaterRepositoryTest {
    private lateinit var repository: WaterRepository
    private lateinit var dao: WaterDao

    @Test
    fun `addWaterRecord should insert into database`() = runTest {
        // Given
        val amount = 100

        // When
        val id = repository.addWaterRecord(amount)

        // Then
        val record = dao.getById(id)
        assertEquals(100, record?.amount)
    }
}

// ViewModel í…ŒìŠ¤íŠ¸
class HomeViewModelTest {
    @Test
    fun `connectToDevice should update connectionState`() = runTest {
        // Given
        val viewModel = HomeViewModel(application)
        val device = mockBluetoothDevice

        // When
        viewModel.connectToDevice(device)

        // Then
        assertEquals(BluetoothConnectionState.CONNECTED, viewModel.connectionState.value)
    }
}

// Compose UI í…ŒìŠ¤íŠ¸
@Test
fun homeScreen_displays_todayIntake() {
    composeTestRule.setContent {
        HomeScreen(viewModel = mockViewModel)
    }

    composeTestRule
        .onNodeWithText("0 / 2000 ml")
        .assertIsDisplayed()
}
```

---

## 13. ì„±ëŠ¥ ìµœì í™”

### 13.1 Compose Recomposition ìµœì í™”

```kotlin
// Bad: ì „ì²´ recompose
@Composable
fun Screen(viewModel: HomeViewModel) {
    val state by viewModel.state.collectAsState()

    Column {
        Header(state.title)  // state ë³€ê²½ ì‹œë§ˆë‹¤ recompose
        Content(state.data)  // state ë³€ê²½ ì‹œë§ˆë‹¤ recompose
    }
}

// Good: í•„ìš”í•œ ë¶€ë¶„ë§Œ recompose
@Composable
fun Screen(viewModel: HomeViewModel) {
    Column {
        Header(viewModel.title.collectAsState().value)  // title ë³€ê²½ ì‹œë§Œ
        Content(viewModel.data.collectAsState().value)  // data ë³€ê²½ ì‹œë§Œ
    }
}
```

### 13.2 ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”

```kotlin
// Bad: N+1 ì¿¼ë¦¬
suspend fun getDailyStats(dates: List<String>): List<DailyIntake> {
    return dates.map { date ->
        val records = dao.getRecordsByDateOnce(date)  // Në²ˆ ì¿¼ë¦¬
        // ...
    }
}

// Good: ë‹¨ì¼ ì¿¼ë¦¬
suspend fun getDailyStats(startDate: String, endDate: String): List<DailyIntake> {
    val allRecords = dao.getRecordsByDateRange(startDate, endDate)  // 1ë²ˆ ì¿¼ë¦¬
    return allRecords.groupBy { it.date }.map { (date, records) ->
        // ...
    }
}
```

### 13.3 ë©”ëª¨ë¦¬ ê´€ë¦¬

```kotlin
// ViewModel
override fun onCleared() {
    super.onCleared()
    bluetoothManager.cleanup()  // ë¦¬ì†ŒìŠ¤ ì •ë¦¬
}

// BluetoothManager
fun cleanup() {
    scope.cancel()  // ì½”ë£¨í‹´ ì·¨ì†Œ
    disconnect()    // ì†Œì¼“ ë‹«ê¸°
}
```

---

## 14. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 14.1 ê¶Œí•œ ì²˜ë¦¬

```kotlin
// AndroidManifest.xmlì—ì„œ ì„ ì–¸
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />

// ëŸ°íƒ€ì„ ê¶Œí•œ ìš”ì²­
val permissionState = rememberMultiplePermissionsState(
    listOf(Manifest.permission.BLUETOOTH_CONNECT)
)

if (!permissionState.allPermissionsGranted) {
    permissionState.launchMultiplePermissionRequest()
}
```

### 14.2 ë°ì´í„° ë³´í˜¸

```kotlin
// Room Database ì•”í˜¸í™” (ì„ íƒì‚¬í•­)
val passphrase = SQLiteDatabase.getBytes("my-secret-key".toCharArray())
val factory = SupportFactory(passphrase)

Room.databaseBuilder(context, WaterDatabase::class.java, "water_db")
    .openHelperFactory(factory)
    .build()
```

### 14.3 ë¸”ë£¨íˆ¬ìŠ¤ ë³´ì•ˆ

```kotlin
// í˜ì–´ë§ëœ ë””ë°”ì´ìŠ¤ë§Œ ì—°ê²°
val pairedDevices = bluetoothAdapter.bondedDevices
// ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ë§Œ ëª©ë¡ì— í‘œì‹œ
```

---

## 15. ë””ë²„ê¹… íŒ

### 15.1 ë¡œê·¸ í™œìš©

```kotlin
private const val TAG = "HomeViewModel"

fun connectToDevice(device: BluetoothDevice) {
    Log.d(TAG, "Connecting to ${device.name}")

    viewModelScope.launch {
        try {
            bluetoothManager.connect(device)
            Log.d(TAG, "Connected successfully")
        } catch (e: Exception) {
            Log.e(TAG, "Connection failed", e)
        }
    }
}
```

### 15.2 Database Inspector

```
Android Studio â†’ View â†’ Tool Windows â†’ App Inspection
â†’ Database â†’ water_database â†’ water_records
```

### 15.3 Layout Inspector

```
Tools â†’ Layout Inspector
â†’ Compose ê³„ì¸µ êµ¬ì¡° í™•ì¸
â†’ Recomposition íšŸìˆ˜ í™•ì¸
```

---

## 16. ë§ˆë¬´ë¦¬

### 16.1 ì½”ë“œ êµ¬ì¡° ìš”ì•½

```
ì•„í‚¤í…ì²˜: MVVM + Clean Architecture + Repository
UI: Jetpack Compose + Material3
ë°ì´í„°: Room Database + Flow
í†µì‹ : Bluetooth Classic (SPP)
ë¹„ë™ê¸°: Kotlin Coroutines + StateFlow
```

### 16.2 í•µì‹¬ ì›ì¹™

1. **ê´€ì‹¬ì‚¬ ë¶„ë¦¬**: ê° ê³„ì¸µì˜ ì±…ì„ ëª…í™•í™”
2. **ë‹¨ë°©í–¥ ë°ì´í„° í”Œë¡œìš°**: UI â†’ ViewModel â†’ Repository
3. **ë°˜ì‘í˜• í”„ë¡œê·¸ë˜ë°**: Flow/StateFlow í™œìš©
4. **ìƒëª…ì£¼ê¸° ì¸ì‹**: ViewModel, Compose Lifecycle
5. **í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±**: ì˜ì¡´ì„± ì£¼ì…, ì¶”ìƒí™”

### 16.3 í•™ìŠµ í¬ì¸íŠ¸

- **Kotlin**: Coroutines, Flow, StateFlow
- **Android**: MVVM, Room, Bluetooth
- **Compose**: ì„ ì–¸í˜• UI, State ê´€ë¦¬
- **Architecture**: Clean Architecture, Repository íŒ¨í„´

---

**ì´ ë¬¸ì„œë¥¼ í†µí•´ aduino1 ì•±ì˜ ì „ì²´ ì½”ë“œ êµ¬ì¡°ì™€ ë™ì‘ ì›ë¦¬ë¥¼ ì´í•´í•˜ì…¨ê¸°ë¥¼ ë°”ëë‹ˆë‹¤!**

---

*ì‘ì„±: 2025-01-08*
*ë²„ì „: 1.0*
*ëŒ€ìƒ: ì¤‘ê¸‰~ê³ ê¸‰ ê°œë°œì*
